define(["esri/map","esri/dijit/Popup","esri/arcgis/utils","dojo/_base/declare","dojo/on","dojo/_base/connect","dojo/touch","dojo/dom","dojo/_base/lang","dojo/dom-style","dojo/query","dojo/NodeList-traverse","esri/geometry/Point","dojo/domReady!"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";return{create:function(a,b){var c,d;return a&&b?(c=new this._smartResizer(a,b),d=c.createMap(),d._smartResizer=c,d):void 0},createWebMap:function(a,b,c){var d,e;return b&&c?(d=new this._smartResizer(b,c),e=d.createWebMap(a)):void 0},destroy:function(a){function b(a){if(a._handles)for(var b=a._handles.length;b--;)a._handles[b].remove(),a._handles.splice(b,1)}a&&a._smartResizer&&b(a._smartResizer)},_smartResizer:d(null,{_mapDivId:null,_mapDiv:null,_mapStyle:null,_map:null,_autoRecenterDelay:50,_popupRecenterDelayer:150,_popupPosition:"top",_popupBlocked:!1,_visible:!0,_visibilityTimer:null,_mapDeferred:null,constructor:function(a,b){this._mapDivId=a,this._mapDiv=h.byId(a),this._mapStyle=j.get(this._mapDiv),this._options=i.mixin(b,{}),this._handles=[]},createMap:function(){return this._setMapDiv(!1),i.mixin(this._options,{smartNavigation:!1,autoResize:!1}),this._map=new a(this._mapDivId,this._options),this._bindEvents(),this._mapDiv.__map=this._map,this._map},createWebMap:function(a){var b,d,e;return this._setMapDiv(!1),this._options.hasOwnProperty("mapOptions")||(this._options.mapOptions={}),i.mixin(this._options.mapOptions,{smartNavigation:!1,autoResize:!1}),b=c.createMap(a,this._mapDivId,this._options),this._mapDeferred=b,d=this,e=function(a){this._map=a.map,this._bindEvents(),this._mapDiv.__map=this._map,this._smartResizer=d},this._mapDeferred.then(i.hitch(this,e)),b},_setTouchBehavior:function(){this._options.hasOwnProperty("scrollWheelZoom")&&this._options.scrollWheelZoom?this._map.enableScrollWheelZoom():this._map.disableScrollWheelZoom(),e(k(".esriPopup .titleButton.close"),g.press,i.hitch(this,function(){this._map.infoWindow.hide()}))},_bindEvents:function(){var a,b,c,d,f,g,h;this._map&&(a=function(){this._setTouchBehavior()},this._map.loaded?i.hitch(this,a).call():this._handles.push(e(this._map,"load",i.hitch(this,a))),b=function(){this._map.infoWindow.anchor=this._popupPosition;var a=function(a){var b=a._map.infoWindow.location;b&&!a._popupBlocked&&(a._popupBlocked=!0,window.setTimeout(function(){a._repositionMapForInfoWin(b),a._popupBlocked=!1},a._popupRecenterDelayer))};this.counter=0,this._map.on("click",i.hitch(this,function(){this._map.infoWindow.isShowing&&a(this)})),e(this._map.graphics,"click",i.hitch(this,function(){a(this)})),e(this._map.infoWindow,"show",i.hitch(this,function(){a(this)}))},this._map.loaded?i.hitch(this,b).call():this._handles.push(e(this._map,"load",i.hitch(this,b))),c=function(a,b,c){return function(){function e(){c||a.apply(f,g),d=null}var f=this,g=arguments;d?clearTimeout(d):c&&a.apply(f,g),d=setTimeout(e,b||100)}},f=c(this._setMapDiv,100,!1),this._handles.push(e(window,"resize",i.hitch(this,f))),g=function(){this._map.__resizeCenter=this._map.extent.getCenter(),h=function(){this._map.centerAt(this._map.__resizeCenter)},setTimeout(i.hitch(this,h),this._autoRecenterDelay)},this._handles.push(e(this._map,"resize",i.hitch(this,g))))},_getMapDivVisibility:function(){return this._mapDiv.clientHeight>0||this._mapDiv.clientWidth>0},_checkVisibility:function(){var a=this._getMapDivVisibility();this._visible!==a&&a&&this._setMapDiv(!0)},_controlVisibilityTimer:function(a){a?this._visibilityTimer=setInterval(i.hitch(this,function(){this._checkVisibility()}),200):this._visibilityTimer&&(clearInterval(this._visibilityTimer),this._visibilityTimer=null)},_setMapDiv:function(a){if(this._mapDivId){var b,c,d,e,f,g,h,i,k;b=this._getMapDivVisibility(),this._visible!==b&&(this._visible=b,this._controlVisibilityTimer(!b)),this._visible&&(c=window.innerHeight,d=document.body.clientHeight,e=c-d,f=this._calcMapHeight(),g=this._calcColumnHeight(f),h=f+e,i=0,k=!1,g>f?(i=e>0?g+e:g,k=!0):(i=g>h?g:h,k=!1),j.set(this._mapDivId,{height:i+"px",width:"auto"}),this._map&&a&&this._visible&&(this._map.resize(),this._map.reposition()))}},_calcMapHeight:function(){var a=this._mapStyle,b=parseInt(a.paddingTop,10)+parseInt(a.paddingBottom,10),c=parseInt(a.marginTop,10)+parseInt(a.marginBottom,10),d=parseInt(a.borderTopWidth,10)+parseInt(a.borderBottomWidth,10),e=b+c+d+this._mapDiv.clientHeight;return e},_calcColumnHeight:function(){var a,b,c,d=0,e=k(this._mapDiv).closest(".row").children("[class*='col']");if(e.length)for(a=0;a<e.length;a++)b=e[a],c=k("#"+this._mapDivId,b).length>0,b.clientHeight>d&&!c&&(d=b.clientHeight);return d},_repositionMapForInfoWin:function(a){var b=new m(this._map.extent.xmax,this._map.extent.ymax,this._map.spatialReference),c=new m(this._map.extent.getCenter()),d=this._map.toScreen(b),e=this._map.toScreen(c),f=this._map.toScreen(a),g=10,h=3,i=this._map.infoWindow.domNode.childNodes[0],j=i.clientWidth,k=i.clientHeight+this._map.infoWindow.marginTop,l=f.x-j/2,n=f.x+j/2,o=0>l-g,p=n>d.x-g,q=this._map.infoWindow.offsetY,r=f.y-k-q,s=0>r-h;o?e.x-=Math.abs(l)+g<g?g:Math.abs(l)+g:p&&(e.x+=n-d.x+g),s&&(e.y+=r-h),(p||o||s)&&(c=this._map.toMap(e),this._map.centerAt(c))}})}});